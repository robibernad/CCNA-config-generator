!
! Routing Configuration
!

{# ------------------------- #}
{# VRF Definitions           #}
{# ------------------------- #}
{% if vrfs %}
!
! VRF Configuration
{% for vrf in vrfs %}
ip vrf {{ vrf.name }}
 rd {{ vrf.rd }}
{% if vrf.routeTargetExport %}
 route-target export {{ vrf.routeTargetExport }}
{% endif %}
{% if vrf.routeTargetImport %}
 route-target import {{ vrf.routeTargetImport }}
{% endif %}
!
{% endfor %}
{% endif %}

{# ------------------------- #}
{# MPLS LDP Configuration    #}
{# ------------------------- #}
{% if vrfs and vrfs|length > 0 %}
!
! Enable MPLS for L3VPN
mpls label protocol ldp
{% if bgp and bgp.routerId %}
mpls ldp router-id Loopback0 force
{% endif %}
!
{% endif %}

{# ------------------------- #}
{# Default + Static Routes   #}
{# ------------------------- #}
{% if defaultRoute %}
{% if defaultRoute.exitInterface and defaultRoute.nextHop %}
ip route 0.0.0.0 0.0.0.0 {{ defaultRoute.exitInterface }} {{ defaultRoute.nextHop }}{% if defaultRoute.distance %} {{ defaultRoute.distance }}{% endif %}
{% elif defaultRoute.nextHop %}
ip route 0.0.0.0 0.0.0.0 {{ defaultRoute.nextHop }}{% if defaultRoute.distance %} {{ defaultRoute.distance }}{% endif %}
{% elif defaultRoute.exitInterface %}
ip route 0.0.0.0 0.0.0.0 {{ defaultRoute.exitInterface }}{% if defaultRoute.distance %} {{ defaultRoute.distance }}{% endif %}
{% endif %}
!
{% endif %}

{% if staticRoutes %}
{% for route in staticRoutes %}
ip route {% if route.vrf %}vrf {{ route.vrf }} {% endif %}{{ route.destination }} {{ route.subnetMask }} {% if route.exitInterface %}{{ route.exitInterface }} {% endif %}{% if route.nextHop %}{{ route.nextHop }}{% endif %}{% if route.distance %} {{ route.distance }}{% endif %}{% if route.name %} name {{ route.name }}{% endif %}
{% endfor %}
!
{% endif %}

{# ------------------------- #}
{# OSPF Configuration        #}
{# ------------------------- #}
{% if ospf and ospf.processId %}
!
router ospf {{ ospf.processId }}{% if ospf.vrf %} vrf {{ ospf.vrf }}{% endif %}
{% if ospf.routerId %}
 router-id {{ ospf.routerId }}
{% endif %}
{% if ospf.defaultOriginate %}
 default-information originate always
{% endif %}
{% for net in ospf.networks %}
 network {{ net.network }} {{ net.wildcard }} area {{ net.area }}
{% endfor %}
{% for passive in ospf.passiveInterfaces %}
 passive-interface {{ passive }}
{% endfor %}
!
{% for intf in ospf.interfaces %}
interface {{ intf.interface }}
 ip ospf {{ ospf.processId }} area {{ intf.area }}
{% if intf.cost %}
 ip ospf cost {{ intf.cost }}
{% endif %}
{% if intf.priority is not none %}
 ip ospf priority {{ intf.priority }}
{% endif %}
!
{% endfor %}
{% endif %}

{# ------------------------- #}
{# EIGRP Configuration       #}
{# ------------------------- #}
{% if eigrp and eigrp.enabled %}
!
router eigrp {{ eigrp.asn }}
{% if eigrp.routerId %}
 eigrp router-id {{ eigrp.routerId }}
{% endif %}
{% if eigrp.noAutoSummary %}
 no auto-summary
{% endif %}
{% for net in eigrp.networks %}
 network {{ net.network }}{% if net.wildcard %} {{ net.wildcard }}{% endif %}
{% endfor %}
{% for passive in eigrp.passiveInterfaces %}
 passive-interface {{ passive }}
{% endfor %}
!
{% endif %}

{# ------------------------- #}
{# BGP Configuration         #}
{# ------------------------- #}
{% if bgp %}
!
router bgp {{ bgp.asn }}
{% if bgp.routerId %}
 bgp router-id {{ bgp.routerId }}
{% endif %}
 bgp log-neighbor-changes
 !
 {# Global Neighbors #}
{% for neighbor in bgp.neighbors %}
 neighbor {{ neighbor.ip }} remote-as {{ neighbor.remoteAs }}
{% if neighbor.updateSource %}
 neighbor {{ neighbor.ip }} update-source {{ neighbor.updateSource }}
{% endif %}
{% if neighbor.nextHopSelf %}
 neighbor {{ neighbor.ip }} next-hop-self
{% endif %}
{% endfor %}
 !
 {# Address Family IPv4 (Global) #}
 address-family ipv4
{% for net in bgp.networks %}
  network {{ net }}
{% endfor %}
{% for neighbor in bgp.neighbors %}
{% if not neighbor.activateVpnv4 %}
  neighbor {{ neighbor.ip }} activate
{% endif %}
{% endfor %}
 exit-address-family
 !
 {# Address Family VPNv4 (MPLS) #}
{% set has_vpnv4_neighbors = bgp.neighbors | selectattr('activateVpnv4', 'equalto', true) | list | length > 0 %}
{% if has_vpnv4_neighbors %}
 address-family vpnv4
{% for neighbor in bgp.neighbors %}
{% if neighbor.activateVpnv4 %}
  neighbor {{ neighbor.ip }} activate
  neighbor {{ neighbor.ip }} send-community extended
{% endif %}
{% endfor %}
 exit-address-family
 !
{% endif %}
 {# Address Family for VRFs (VRF Lite / L3VPN) #}
{% for vrf in vrfs %}
 address-family ipv4 vrf {{ vrf.name }}
  redistribute connected
{% if ospf and ospf.vrf == vrf.name %}
  redistribute ospf {{ ospf.processId }}
{% endif %}
 exit-address-family
{% endfor %}
!
{% endif %}

{# ------------------------- #}
{# GRE Tunnels               #}
{# ------------------------- #}
{% if greTunnels %}
{% for tunnel in greTunnels %}
!
interface Tunnel{{ tunnel.tunnelNumber }}
 ip address {{ tunnel.tunnelIp }} {{ tunnel.tunnelMask }}
 tunnel source {{ tunnel.sourceInterface }}
 tunnel destination {{ tunnel.destinationIp }}
 tunnel mode gre ip
{% if tunnel.tunnelKey %}
 tunnel key {{ tunnel.tunnelKey }}
{% endif %}
{% if tunnel.mtu %}
 ip mtu {{ tunnel.mtu }}
{% endif %}
{% if tunnel.adjustMss %}
 ip tcp adjust-mss {{ tunnel.adjustMss }}
{% endif %}
{% if tunnel.keepaliveSeconds %}
{% if tunnel.keepaliveRetries %}
 keepalive {{ tunnel.keepaliveSeconds }} {{ tunnel.keepaliveRetries }}
{% else %}
 keepalive {{ tunnel.keepaliveSeconds }}
{% endif %}
{% endif %}
{% if tunnel.ipsecProfile %}
 tunnel protection ipsec profile {{ tunnel.ipsecProfile }}
{% endif %}
!
{% endfor %}
{% endif %}
